{% extends 'base_content.html' %}

{% block content %}
<div class="content-area">
    <div class="fog-box">
        <div class="container my-4">
            <h1>All Tickets</h1>
            {% if tickets %}
                <div class="mb-3">
                    <label for="sort" class="form-label">Sort by:</label>
                    <select id="sort" class="form-select" onchange="sortTickets()">
                        <option value="title" selected>Title</option>
                        <option value="priority">Priority</option>
                        <option value="status">Status</option>
                        <option value="creator">Submitted By</option>
                    </select>
                </div>
                <table class="table" id="ticketTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Submitted By</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                            <tr>
                                <td data-title="{{ ticket.title }}">{{ ticket.title }}</td>
                                <td data-priority="{{ ticket.get_priority_display }}" 
                                    data-priority-value="{% if ticket.get_priority_display == 'Urgent' %}1
                                                         {% elif ticket.get_priority_display == 'High' %}2
                                                         {% elif ticket.get_priority_display == 'Medium' %}3
                                                         {% elif ticket.get_priority_display == 'Low' %}4
                                                         {% else %}5{% endif %}">
                                    {{ ticket.get_priority_display }}
                                </td>
                                <td data-status="{{ ticket.get_status_display }}" 
                                    data-status-value="{% if ticket.get_status_display == 'Open' %}1
                                                       {% elif ticket.get_status_display == 'In Progress' %}2
                                                       {% elif ticket.get_status_display == 'Closed' %}3
                                                       {% else %}4{% endif %}">
                                    {{ ticket.get_status_display }}
                                </td>
                                <td data-creator="{{ ticket.creator.username }}">{{ ticket.creator.username }}</td>
                                <td>    
                                    <a href="{% url 'ticket_detail' ticket_id=ticket.id %}?from=list" 
                                       class="btn btn-sm btn-primary">View</a>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No tickets found.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function sortTickets() {
        let table = document.getElementById("ticketTable");
        let tbody = table.getElementsByTagName("tbody")[0];
        let rows = Array.from(tbody.getElementsByTagName("tr"));
        let sortBy = document.getElementById("sort").value;

        rows.sort((a, b) => {
            let aData, bData;
            if (sortBy === "priority") {
                aData = parseInt(a.querySelector("[data-priority-value]").dataset.priorityValue);
                bData = parseInt(b.querySelector("[data-priority-value]").dataset.priorityValue);
                return aData - bData;
            } else if (sortBy === "status") {
                aData = parseInt(a.querySelector("[data-status-value]").dataset.statusValue);
                bData = parseInt(b.querySelector("[data-status-value]").dataset.statusValue);
                return aData - bData;
            } else {
                aData = a.querySelector(`[data-${sortBy}]`).dataset[sortBy].toLowerCase();
                bData = b.querySelector(`[data-${sortBy}]`).dataset[sortBy].toLowerCase();
                return aData.localeCompare(bData);
            }
        });

        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
    }

    document.addEventListener("DOMContentLoaded", () => {
        setTimeout(() => {
            sortTickets();
        }, 100);
    });
</script>
{% endblock %}

