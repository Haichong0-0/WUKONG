{% extends 'base_content.html' %}

{% block content %}
<div class="container my-4">
  <div class="row">
    <div class="col-12">
      <h1 class="text-center text-primary">Welcome to your dashboard, {{ user.username }}</h1>

      <ul class="nav nav-pills mb-3" id="dashboard-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="profile-tab" data-bs-toggle="pill" href="#profile" role="tab" aria-controls="profile" aria-selected="true">Profile</a>
        </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link active" id="tickets-tab" data-bs-toggle="pill" href="#tickets" role="tab" aria-controls="tickets" aria-selected="false">Tickets</a>
        </li>
      </ul>

      <div class="tab-content" id="dashboard-tabs-content">
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
          <h2>Your Profile</h2>
          <ul class="list-group">
            <li class="list-group-item"><strong>Username:</strong> {{ user.username }}</li>
            <li class="list-group-item"><strong>Email:</strong> {{ user.email }}</li>
            <li class="list-group-item"><strong>First Name:</strong> {{ user.first_name }}</li>
            <li class="list-group-item"><strong>Last Name:</strong> {{ user.last_name }}</li>
            <li class="list-group-item"><strong>Role:</strong>
              {% if user.is_program_officer %}
                Program Officer
              {% elif user.is_specialist %}
                Specialist
              {% elif user.is_student %}
                Student
              {% else %}
                Unknown
              {% endif %}
            </li>
          </ul>
        </div>

        <!-- Search Box -->
        <div class="search-box mb-4">
          <form method="GET" action="{% url 'dashboard' %}">
              <div class="input-group">
                  <input 
                      type="text" 
                      class="form-control" 
                      name="search" 
                      value="{{ request.GET.search }}" 
                      placeholder="Search for questions and replies..."
                  >
                  <button type="submit" class="btn btn-primary">
                      Search
                  </button>
                </div>
            </form>
        </div>

        <div class="tab-pane fade show active" id="tickets" role="tabpanel" aria-labelledby="tickets-tab">
          {% if user.is_program_officer %}
            <h2>Tickets</h2>
            <table class="table table-bordered table-striped table-light">
              <thead class="table-blue">
                <tr>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Priority</th>
                  <th>Assigned To</th>
                  <th>Answers</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for ticket in all_tickets %}
                  <tr>
                    <td>{{ ticket.title }}</td>
                    <td>{{ ticket.assigned_department }}</td>
                    <td>{{ ticket.status }}</td>
                    <td>{{ ticket.priority }}</td>
                    <td>{{ ticket.assigned_user }}</td>
                    <td>
                      <!-- Check if ticket.answers is None or empty -->
                      {% if ticket.answers %}
                        Answered
                      {% else %}
                        Not yet answered
                      {% endif %}
                    </td>
                    <td>
                      <!-- Redirect Ticket Button -->
                      <form method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                        <select name="new_assignee_id" required>
                          <option value="" disabled selected>Select a specialist</option>
                          {% for specialist in ticket_stats %}
                            <option value="{{ specialist.id }}">{{ specialist.full_name }} - {{ specialist.department }}</option>
                          {% endfor %}
                        </select>
                        <button type="submit" name="redirect_ticket" class="btn btn-sm btn-warning">Redirect to Specialist</button>
                      </form>
                      
                      <br>
                      <form method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                        <textarea name="response_message" placeholder="Enter your response here..." required></textarea>
                        <button type="submit" name="respond_ticket" class="btn btn-sm btn-primary">Respond</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>

            <h2>Specialist Ticket Assignment Statistics</h2>
            <table class="table table-bordered table-striped table-light">
              <thead class="table-blue">
                <tr>
                  <th>Specialist</th>
                  <th>Assigned Tickets</th>
                </tr>
              </thead>
              <tbody>
                {% for specialist in ticket_stats %}
                  <tr>
                    <td>{{ specialist.full_name }}</td>
                    <td>{{ specialist.ticket_count }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}

          {% if user.is_student %}
            <h2>Your Submitted Tickets</h2>
            <!-- Messages Section -->
            {% if not student_tickets %}
              {% if request.GET.search %}
                  <div class="alert alert-info" role="alert">
                      No tickets found matching your search criteria. Try a different search term.
                  </div>
              {% else %}
                  <div class="alert alert-info" role="alert">
                      No tickets posted at the moment.
                  </div>
              {% endif %}
              {% else %}
                <table class="table table-bordered table-striped table-light">
                  <thead class="table-blue">
                    <tr>
                      <th>Title</th>
                      <th>Status</th>
                      <th>Priority</th>
                      <th>Answers</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ticket in student_tickets %}
                      <tr>
                        <td>{{ ticket.title }}</td>
                        <td>{{ ticket.status }}</td>
                        <td>{{ ticket.priority }}</td>
                        <td>
                          <!-- Display the answers for the ticket -->
                          <pre>{{ ticket.answers }}</pre>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
            {% endif %}
          {% endif %}

          {% if user.is_specialist %}
            <h2>Your Assigned Tickets</h2>
            <table class="table table-bordered table-striped table-light">
              <thead class="table-blue">
                <tr>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Priority</th>
                  <th>Answers</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for ticket in assigned_tickets %}
                  <tr>
                    <td>{{ ticket.title }}</td>
                    <td>{{ ticket.status }}</td>
                    <td>{{ ticket.priority }}</td>
                    <td>
                      <!-- Display the answers for the ticket -->
                      <pre>{{ ticket.answers }}</pre>
                    </td>
                    <td>
                      <!-- Respond Ticket Form -->
                      <form method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="ticket_id" value="{{ ticket.id }}">
                        <textarea name="response_message" placeholder="Enter your response here..." required></textarea>
                        <button type="submit" name="respond_ticket" class="btn btn-sm btn-primary">Respond</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
